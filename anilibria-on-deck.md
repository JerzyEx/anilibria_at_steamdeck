## Установка приложения на консоль Steam Deck со сборкой из исходников

*Данный набор команд написан для полностью чистой системы.*
**Внимание! Если найдете ошибки в командах или будут предложения по улучшению то создавайте ишью!**

Данное руководство рассчитано на подготовленого пользователя консоли, который знаком с режимом рабочего стола. Базовые вещи описаны на [портале поддержки Steam](https://help.steampowered.com/ru/faqs/view/671A-4453-E8D2-323C). Убедитесь, что на консоли установлена последняя версия SteamOS. На момент написания статьи актуальной была версия 3.5.19. Так же необходимо иметь базовые представления об терминале Linux.

**Внимание! Все манипуляции проводятся в режиме рабочего стола**

**Этап 1. Подготовка DistroBox**

Начиная с версии SteamOS 3.5 DistroBox включен в состав системы. Необходимо только добавить возможность работы программ с графическим интерфесом. Для этого в файле `~/.distroboxrc` добавить следующую строку:

```
xhost +si:localuser:$USER >/dev/null
```

**Этап 2. Установка Ubuntu в DistroBox**
Далее команды выполняются в терминале

```bash
distrobox create --image docker.io/library/ubuntu:22.04 ubuntu
```

**Этап 3. Переход в Ubuntu**

После команды
```bash
distrobox enter ubuntu
```
все дальнейшие команды выполняются внутри гостевой Ubuntu. Это можно сравнить с виртуальной машиной, но многие ресурсы используются совместно с хостом. В частности общая домашняя папка пользователя.
Первый запуск займет некоторое время. Признаком того, что мы находимся внутри гостевой системы является промпт `deck@ubuntu:~$ `

**Этап 4. Установка приложения из исходников**

Воспользуйтесь [инструкцией](https://github.com/anilibria/anilibria-winmaclinux/blob/master/linuxmint20.md) для сборки. **Обязательно собирайте с поддержкой  mpv.**
После окончания сборки и установки командой ``sudo make install`` необходимо установить дополнительные кодеки:
```bash
sudo apt install ubuntu-restricted-extras
```
Если хотите добиться работы стандартного плеера, то необходимо установить ещё несколько пакетов:

```bash
sudo apt install libgstreamer1.0-dev libgstreamer-plugins-base1.0-dev libgstreamer-plugins-bad1.0-dev gstreamer1.0-plugins-base gstreamer1.0-plugins-good gstreamer1.0-plugins-bad gstreamer1.0-plugins-ugly gstreamer1.0-libav gstreamer1.0-tools gstreamer1.0-x gstreamer1.0-alsa gstreamer1.0-gl gstreamer1.0-gtk3 gstreamer1.0-qt5 gstreamer1.0-pulseaudio
```

Затем надо проверить работоспособность приложения не покидая гостевой системы. Для этого необходимо выполнить в терминале следующую команду:
```bash
/opt/AniLibria/bin/AniLibria
```
Сейчас достаточно чтобы приложение запустилось и показало каталог. Воспроизведение видео может не работать и падать с ошибкой ``Segmentation fault (core dumped)``. Для нормальной работы необходимо поменять плеер по умолчанию. Внутри приложения это сделать не получится. Необходимо отредактировать файл `~/.local/share/EmptyFlow/AnilibriaDesktopClient/userconfiguration.cache` изменив значение `"lastSelectedPlayer"` с `"Default"` на `"mpv"`. В итоге строка должна получить такой вид:
```
"lastSelectedPlayer": "mpv",
```
*Примечание. Данный файл можно открыть из SteamOS, а не пользоваться консольными редакторами*

**Этап 5. Экспорт приложения в основную систему**
Находясь внутри терминала гостевой системы (убедитесь, что промпт выглядит как `deck@ubuntu:~$`) необходимо выполнить команду
```bash
distrobox-export --app /opt/AniLibria/bin/AniLibria
```
Теперь можно спокойно выйти из гостевой системы командой
```bash
exit
```
И закрыть окно терминала

**Этап 6. Установка TorrentStream (необязательно)**
Для улучшения качества доставки контента рекомендуется TorrentStream установить по [инструкции](https://github.com/anilibria/anilibria-winmaclinux/blob/master/torrentstream.md). Имейте ввиду, что папка с этим приложением должна находится в домашней директории пользователя. В приложении AniLibria необходимо указывать полный путь относительно корня, например такой: */home/deck/Soft/TorrentStream/torrentStream*

**Этап 7. Добавление приложения в Gaming mode (необязательно)**
Добавление и настройка описаны в отдельном [руководстве](FIXME_gaming_mode.md)
### Как найти приложение?
Приложение будет доступно из раздела меню "Мультимедиа" по имени "AniLibria (on ubuntu)".

### Как обновить приложение?
Для того чтобы обновить приложение необходимо в терминале войти в гостевую систему:
```bash
distrobox enter ubuntu
```
И действовать по [инструкции](https://github.com/anilibria/anilibria-winmaclinux/blob/master/linuxmint20.md#%D0%BA%D0%B0%D0%BA-%D0%BE%D0%B1%D0%BD%D0%BE%D0%B2%D0%B8%D1%82%D1%8C-%D0%BF%D1%80%D0%B8%D0%BB%D0%BE%D0%B6%D0%B5%D0%BD%D0%B8%D0%B5). После окончания сборки и установки командой ``sudo make install`` можно выйти из гостевой системы командой
```bash
exit
```
Больше никаких действий производить не надо.
